<polymer-element name="ceci-collections" attributes="">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <content></content>
  </template>
  <script>
    window.collections = {};
    var collectionObserver;
    collections.kinds = [
      "Number", "Toggle", "Text", "Name", "Address", "HttpUrl", "Color", "Image"
    ];

    Polymer('ceci-collections', {
      ready: function() {},
      attached: function() {
        var collectionElement = this;
        // This is meant to be the raw data that gets saved in the element.
        var savedData = {};
        // Listen for changes in the fields so we can fire external events.
        function fieldObserver(added, removed, changed, getOldValueFn) {
          var field = this.field;
          var collection = this.collection;
          function updateKey(key) {
            var detail = {
              key: key,
              added: added[key] || changed[key],
              removed: getOldValueFn(key),
              collection: collection,
              field: field
            };
            collectionElement.textContent = JSON.stringify(savedData);
            var customEvent = new CustomEvent("ceci-data-change", {detail:detail});
            document.dispatchEvent(customEvent);
          }
          Object.keys(added).forEach(function(key) {
            savedData[collection].fields[field][key] = added[key];
            updateKey(key);
          });
          Object.keys(removed).forEach(function(key) {
            delete savedData[collection].fields[field][key];
            updateKey(key);
          });
          Object.keys(changed).forEach(function(key) {
            savedData[collection].fields[field][key] = changed[key];
            updateKey(key);
          });
        }

        function fieldsObserver(added, removed, changed, getOldValueFn) {
          var collection = this.collection;
          Object.keys(added).forEach(function(field) {
            savedData[collection].fields[field] = added[field] || {};
            collectionElement.textContent = JSON.stringify(savedData);
            setupFieldObserver(collection, field);
          });
          Object.keys(removed).forEach(function(field) {
            delete savedData[collection].fields[field];
            collectionElement.textContent = JSON.stringify(savedData);
          });
          Object.keys(changed).forEach(function(field) {
            savedData[collection].fields[field] = changed[field] || {};
            collectionElement.textContent = JSON.stringify(savedData);
            setupFieldObserver(collection, field);
          });
        }

        // Listen for new collections so we can internally setup our events.
        function collectionsObserver(added, removed, changed, getOldValueFn) {
          Object.keys(added).forEach(function(collection) {
            savedData[collection] = {
              fields: added[collection].fields || {}
            };
            collectionElement.textContent = JSON.stringify(savedData);
            collections[collection].fields = added[collection].fields || {};
            setupFieldsObserver(collection);
          });
          Object.keys(removed).forEach(function(collection) {
            delete savedData[collection];
            collectionElement.textContent = JSON.stringify(savedData);
          });
          Object.keys(changed).forEach(function(collection) {
            savedData[collection] = {
              fields: changed[collection].fields || {}
            };
            collectionElement.textContent = JSON.stringify(savedData);
            collections[collection].fields = changed[collection].fields || {};
            setupFieldsObserver(collection);
          });
        }

        function setupFieldObserver(collection, field) {
          new ObjectObserver(collections[collection].fields[field]).open(fieldObserver, {
            collection: collection,
            field: field
          });
        }

        function setupFieldsObserver(collection) {
          collections[collection].fields.on = function(event, listener) {
            document.addEventListener("ceci-data-" + event, listener);
          };
          collections[collection].fields.off = function(event, listener) {
            document.removeEventListener("ceci-data-" + event, listener);
          };
          Object.keys(collections[collection].fields).forEach(function(field) {
            setupFieldObserver(collection, field);
          });
          new ObjectObserver(collections[collection].fields).open(fieldsObserver, {
           collection: collection
          });
        }

        if (this.textContent !== "") {
          try {
            savedData = JSON.parse(this.textContent);
          } catch (e) {
            console.error("Parsing error:", e);
          }
        }
        // Load in any previously saved schema info.
        Object.keys(savedData).forEach(function(collection) {
          collections[collection] = savedData[collection];
          setupFieldsObserver(collection);
        });
        if (collectionObserver) {
          collectionObserver.close();
        }
        collectionObserver = new ObjectObserver(collections);
        collectionObserver.open(collectionsObserver);
      }
    });
  </script>
</polymer-element>
