<polymer-element name="ceci-chef-adventure" extends="ceci-element"
  attributes="ground1 ground2 wall1 wall2 wall3 wall4 blueswitch greenswitch redswitch groundsprite1 groundsprite2 wall1sprite wall2sprite wall3sprite wall4sprite playersprite object1sprite object2sprite object3sprite" object1sprite="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAzElEQVRYhe3UvQ2DMBAFYIZhA6qMwAbMwAQpYQRYBykrpKSijZSWVFRH9QqecjE/jnxYnPQahPw+2ZaT5JqNk94y+ZV4AShwzd8gwQC84OPzkm8ZplGGaZS676TuO3+QYADechRwMaZ5PxeJD8CFAHEAOHwUwQCuYu0SIkVbSdFW+4/CLEC7hC7A5qMwB+AHZi0gv5eLnBfADwwKtACK4Pt5AAxBMbaSCzj83+GXMDhAW9gF2L31ZgAM0S6Zt0tnFsCQtfFWbAZwTbQzA8rYHDy1wvBhAAAAAElFTkSuQmCC" object2sprite="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAgklEQVRYhe3VwQ2AIBBEUXqyBzqlJy7Wsh6Q6AIBzAquZEjmKP/FC8Y8P9TY8DMdwAKtMwL0GaAc3LeueWfJOyuCKAPEy8mcy35+2AqAzjAPXt/JIQAAAAAAAPwEkDy/ACwF4JAMEHa78PWwUkDnYngJAIPEpYFKUBxWA6iCZgSHAg7zXEk/1N6i5AAAAABJRU5ErkJggg==" object3sprite="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAo0lEQVRYhe3WQQ6AIAwEwPX/T/JnXOpBQ0SFtlAsRDfhooadiGkE9CFmdY8bgAAQl54QN4CsOIAQQMu6L0uIG4CA04ZHAQewhPwAN8BjMQfIQeJ1BWRMQGumAIgGTtww3I9HdEQFyByAXLEUMj6A+/i+B7gNFCVAM5rdASZHkb1vPQndAVxqXv0wgARSG7M/Ik9AApGCrs+3FA8DKILeKOwK2AD53p+z3UDayAAAAABJRU5ErkJggg=="
  groundsprite1="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAhUlEQVRYhe3XwQ2AIAwF0JowL2ENZiCM5ghsgNa7CQG02C96+Oc+4KcJtO4La4Y+A7CB2AYCBrho2EXzOAQHUErKnlP2Ylfe3QE1wNXBvRBcwGjY+wDSg/EB0oupdAA8QOsCkYLgAaSepLW0+IC7ZaxB8AGjMzFgq2R+wCn4/wKt/AB1wAEpUF7eamflHQAAAABJRU5ErkJggg==" groundsprite2="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAcElEQVRYhWNoyzr3fyAxw7B3wOKWR/8Xtzwahg7wtKlBwXSPggFzAK4gJdchow4Yeg5AdwihbDZ0HEBpdhp1wNB3wEDhUQcMHQdQq/pFL7gGvwPQNYxcB1Ba6eDCg98BtMbDzwGkJtLh54ABjwJSMQAlEeLHwgfp4wAAAABJRU5ErkJggg=="
  wall1sprite="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAk0lEQVRYhWOom8vzv24uz//de1aQhGH6KNXPMOAOaMhy/t+Q5fx/ydRSkjDMIEr1jzpg5Dlg9+5lEDxiHTDgUTDqAKIdUJ/l9L8+y2kEOABWKcAMIhajV0bk6h88DhhtD5CaiA4dXPP/0ME1BBMhrOjFpX/4O4CQ/uHnAEIF2PB3wIBHwagDRh1AsgMGTXU8UA4AANEaiS8F8jfjAAAAAElFTkSuQmCC"
  wall2sprite="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAiUlEQVRYhWM40SPwfyAxw4A7INeK6f9A4MHnAJjAgiBmmuKh4wBqJ7ah5wBq4W21LP+31bIMQQfAxHEZSAgPHwfUOEHwqANwRQk6Rjdn1AGjDhh+DiCEqV4UDxoHEAp6XHjoOOBQK8v/Q62YCsnFQ9cBsCCnFkaPksHvAGo3RgnhweMAeuNB4wAA8HXyXulpvwIAAAAASUVORK5CYII="
  wall3sprite="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAeUlEQVRYhWNY3PLo/0BihgF3gKdNzX9Pm5r/bVnnaIJhFuESH7oOgOkjV//QdQCuICXXnFEHDD0HoBuAy0FDzwG0LpBGHTD4HUAvi0cdMHQdQK3ESnaTbMAcgF7UjlwHkFvpUJwIB9wBtMLD1wHEmjf4HDBQeMAdAACZk61XAUosyAAAAABJRU5ErkJggg=="
  wall4sprite="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAbElEQVRYhWPwmV3632d26f+JV6cPCGYYcAcYlAT9NygJ+g9zCL3wqAOGvgNgBgx/B8DkycVD3wHkFjDDzwHEJtZRB4w6YNQBw98BhPDwdQAujEvd8HEArfCoA4aOA4htYg19B9Abwxwy4A4AAEMumjQBe3MiAAAAAElFTkSuQmCC" playersprite="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAoUlEQVRYhe3TsQ2AIBBAUXawI1ZOYMIYVi7jLI7gGtc7BCGhtGGBs6LwkGAMipgrfgOX4zUI5xyWTDCAAcUBWmvMGQAcSs2XB1hrMWcUkJpnQD0Auvhq9QG2dXm0egAwTwjzFCxoZYOtbII5eh7bw4B6AFeLQV/7BdkBxphD46BO8w/76L3qO1R9F+zzfRdAITFAKgb8B+AX3Y0BsYc/A9gBIK4UDHNyGoUAAAAASUVORK5CYII=">
  <ceci-definition>
    {
      "name": "Chef Adventure",
      "thumbnail": "./thumbnail.png",
      "description": "",
      "attributes": {
        "playersprite": {
          "description": "",
          "label": "Player Sprite",
          "editable": "sprite",
          "scale": 2
        },
        "groundsprite1": {
          "description": "",
          "label": "Ground Sprite One",
          "editable": "sprite",
          "scale": 2
        },
        "groundsprite2": {
          "description": "",
          "label": "Ground Sprite Two",
          "editable": "sprite",
          "scale": 2
        },
        "wall1sprite": {
          "description": "",
          "label": "Wall One Sprite",
          "editable": "sprite",
          "scale": 2
        },
        "wall2sprite": {
          "description": "",
          "label": "Wall Two Sprite",
          "editable": "sprite",
          "scale": 2
        },
        "wall3sprite": {
          "description": "",
          "label": "Wall Three Sprite",
          "editable": "sprite",
          "scale": 2
        },
        "wall4sprite": {
          "description": "",
          "label": "Wall Four Sprite",
          "editable": "sprite",
          "scale": 2
        },
        "object1sprite": {
          "description": "",
          "label": "Object One Sprite",
          "editable": "sprite",
          "scale": 2
        },
        "object2sprite": {
          "description": "",
          "label": "Object Two Sprite",
          "editable": "sprite",
          "scale": 2
        },
        "object3sprite": {
          "description": "",
          "label": "Object Three Sprite",
          "editable": "sprite",
          "scale": 2
        }
      },
      "broadcasts": {
        "switched": {
          "label": "",
          "description": ""
        },
        "exitleft": {
          "description": "",
          "label": ""
        },
        "exitright": {
          "description": "",
          "label": ""
        },
        "exittop": {
          "description": "",
          "label": ""
        },
        "exitbottom": {
          "description": "",
          "label": ""
        },
        "tilestep": {
          "description": "",
          "label": "Tile stepped on"
        },
        "blockcollision": {
          "description": "",
          "label": "Block collision"
        }
      },
      "listeners": {
        "switched": {
          "description": "",
          "label": ""
        },
        "buttonpress": {
          "description": "",
          "label": ""
        },
        "buttonrelease": {
          "description": "",
          "label": ""
        },
        "enterleft": {
          "description": "",
          "label": ""
        },
        "enterright": {
          "description": "",
          "label": ""
        },
        "entertop": {
          "description": "",
          "label": ""
        },
        "enterbottom": {
          "description": "",
          "label": ""
        },
        "entertile": {
          "description": "",
          "label": ""
        },
        "pushblock": {
          "description": "",
          "label": "Push Block"
        },
        "destroyblock": {
          "description": "",
          "label": "Destroy Block"
        }
      }
    }
  </ceci-definition>
  <template>
    <link rel="stylesheet" href="component.css"></link>
    <div class="player-container"></div>
    <div class="tile-palette-container">
      <div class="tile-palette">
        <div class="palette-blocks">
          <div>
            <span class="palette-block palette-ground1-block palette-selected" data-palette="ground1" on-click="{{onTileClicked}}" style="{{ground1}}"></span>
            <span class="palette-block palette-ground2-block" data-palette="ground2" on-click="{{onTileClicked}}" style="{{ground2}}"></span>
          </div>
          <div>
            <span class="palette-block palette-wall1-block" data-palette="wall1" on-click="{{onTileClicked}}" style="{{wall1}}"></span>
            <span class="palette-block palette-wall2-block" data-palette="wall2" on-click="{{onTileClicked}}" style="{{wall2}}"></span>
            <span class="palette-block palette-wall3-block" data-palette="wall3" on-click="{{onTileClicked}}" style="{{wall3}}"></span>
            <span class="palette-block palette-wall4-block" data-palette="wall4" on-click="{{onTileClicked}}" style="{{wall4}}"></span>
          </div>
          <div>
            <span class="palette-block palette-clearobject" data-palette="clearobject" on-click="{{onObjectClicked}}" style="{{clearobject}}">
              <span></span>
            </span>
            <span class="palette-block palette-object1" data-palette="object1" on-click="{{onObjectClicked}}" style="{{object1}}"></span>
            <span class="palette-block palette-object2" data-palette="object2" on-click="{{onObjectClicked}}" style="{{object2}}"></span>
            <span class="palette-block palette-object3" data-palette="object3" on-click="{{onObjectClicked}}" style="{{object3}}"></span>
          </div>
        </div>
      </div>
    </div>
    <shadow></shadow>
  </template>
  <tags>game</tags>
    <script>
      Polymer("ceci-chef-adventure", {
        ready: function() {
          this.super();
          this.rows = 9;
          this.cols = 9;
          this.generateBoard();
          this.clearobject = "background-image: rgba(0, 0, 0, 0);";
          this.palette = "ground1";
		    },
        groundsprite1Changed: function() {
          var color = "url('" + this.groundsprite1 + "')";
          var palette = this.shadowRoot.querySelector(".palette-ground1-block");
          this[palette.getAttribute("data-palette")] = "background-image: " + color + ";";
        },
        groundsprite2Changed: function() {
          var color = "url('" + this.groundsprite2 + "')";
          var palette = this.shadowRoot.querySelector(".palette-ground2-block");
          this[palette.getAttribute("data-palette")] = "background-image: " + color + ";";
        },
        playerspriteChanged: function() {
          var player = this.querySelector(".player");
          if (!player) {
            return;
          }
          player.style.backgroundImage = "url('" + this.playersprite + "')";
        },
        wall1spriteChanged: function() {
          var color = "url('" + this.wall1sprite + "')";
          var palette = this.shadowRoot.querySelector(".palette-wall1-block");
          this[palette.getAttribute("data-palette")] = "background-image: " + color + ";";
        },
        wall2spriteChanged: function() {
          var color = "url('" + this.wall2sprite + "')";
          var palette = this.shadowRoot.querySelector(".palette-wall2-block");
          this[palette.getAttribute("data-palette")] = "background-image: " + color + ";";
        },
        wall3spriteChanged: function() {
          var color = "url('" + this.wall3sprite + "')";
          var palette = this.shadowRoot.querySelector(".palette-wall3-block");
          this[palette.getAttribute("data-palette")] = "background-image: " + color + ";";
        },
        wall4spriteChanged: function() {
          var color = "url('" + this.wall4sprite + "')";
          var palette = this.shadowRoot.querySelector(".palette-wall4-block");
          this[palette.getAttribute("data-palette")] = "background-image: " + color + ";";
        },
        object1spriteChanged: function() {
          var color = "url('" + this.object1sprite + "')";
          var palette = this.shadowRoot.querySelector(".palette-object1");
          this[palette.getAttribute("data-palette")] = "background-image: " + color + ";";
        },
        object2spriteChanged: function() {
          var color = "url('" + this.object2sprite + "')";
          var palette = this.shadowRoot.querySelector(".palette-object2");
          this[palette.getAttribute("data-palette")] = "background-image: " + color + ";";
        },
        object3spriteChanged: function() {
          var color = "url('" + this.object3sprite + "')";
          var palette = this.shadowRoot.querySelector(".palette-object3");
          this[palette.getAttribute("data-palette")] = "background-image: " + color + ";";
        },
        onTileClicked: function(event, detail, sender) {
          this.shadowRoot.querySelector(".palette-selected").classList.remove("palette-selected");
          sender.classList.add("palette-selected");
          this.palette = sender.getAttribute("data-palette");
          this.objectPalette = "";
        },
        onObjectClicked: function(event, detail, sender) {
          this.shadowRoot.querySelector(".palette-selected").classList.remove("palette-selected");
          sender.classList.add("palette-selected");
          this.palette = "";
          this.objectPalette = sender.getAttribute("data-palette");
        },
        buttonpress: function(direction) {
          var player = this.querySelector(".player");
          if (!player) {
            return;
          }
          var playerRow = player.offsetTop / 32;
          var playerCol = player.offsetLeft / 32;
          var targetCol;

          this.direction = direction;
          if (direction === "up") {
            if (playerRow === 0) {
              this.broadcast("exittop", playerCol);
              player.parentNode.removeChild(player);
              return;
            }
            playerRow--;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
          } else if (direction === "down") {
            if (playerRow === 8) {
              this.broadcast("exitbottom", playerCol);
              player.parentNode.removeChild(player);
              return;
            }
            playerRow++;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
          } else if (direction === "left") {
            if (playerCol === 0) {
              this.broadcast("exitleft", playerRow);
              player.parentNode.removeChild(player);
              return;
            }
            playerCol--;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
          } else if (direction === "right") {
            if (playerCol === 8) {
              this.broadcast("exitright", playerRow);
              player.parentNode.removeChild(player);
              return;
            }
            playerCol++;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
          }
          if (targetCol) {
            if (!targetCol.classList.contains("wall")) {
              player.style.top = (playerRow * 32) + "px";
              player.style.left = (playerCol * 32) + "px";
              this.broadcast("tilestep", targetCol.getAttribute("data-col-type"));
            } else {
              this.broadcast("blockcollision", targetCol.getAttribute("data-col-type"));
            }
          }
        },
        navigateHere: function() {
          var parent = this.parentNode;
          while (parent.nodeName !== "CECI-CARD") {
            parent = parent.parentNode;
          }
          if (parent) {
            parent.show();
          }
        },
        enterleft: function(row) {
          this.enter(row, 0);
        },
        enterright: function(row) {
          this.enter(row, 8);
        },
        entertop: function(col) {
          this.enter(0, col);
        },
        enterbottom: function(col) {
          this.enter(8, col);
        },
        entertile: function(tile) {
          var targetBlock = this.querySelector('*[data-col-type="'+ tile + '"]');
          if (!targetBlock) {
            // If we didn't find a valid block, we enter at a default location.
            // This makes things easier to setup for the first time.
            this.enter(0, 1);
            return;
          }
          var targetCol = targetBlock.getAttribute("data-col");
          var targetRow = targetBlock.parentNode.getAttribute("data-row");
          this.enter(targetRow, targetCol);
        },
        destroyblock: function() {
          var player = this.querySelector(".player");
          if (!player) {
            return;
          }
          var playerRow = player.offsetTop / 32;
          var playerCol = player.offsetLeft / 32;
          var targetCol;
          var direction = this.direction;
          var blockToPush;
          if (direction === "up") {
            if (playerRow === 0) {
              return;
            }
            playerRow--;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
            if (targetCol) {
              targetCol.classList.remove("wall");
              targetCol.setAttribute("data-col-type", "ground1");
              targetCol.style.backgroundImage = "url('" + this.groundsprite1 + "')";
            }
          } else if (direction === "down") {
            if (playerRow === 8) {
              return;
            }
            playerRow++;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
            if (targetCol) {
              targetCol.classList.remove("wall");
              targetCol.setAttribute("data-col-type", "ground1");
              targetCol.style.backgroundImage = "url('" + this.groundsprite1 + "')";
            }
          } else if (direction === "left") {
            if (playerCol === 0) {
              return;
            }
            playerCol--;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
            if (targetCol) {
              targetCol.classList.remove("wall");
              targetCol.setAttribute("data-col-type", "ground1");
              targetCol.style.backgroundImage = "url('" + this.groundsprite1 + "')";
            }
          } else if (direction === "right") {
            if (playerCol === 8) {
              return;
            }
            playerCol++;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
            if (targetCol) {
              targetCol.classList.remove("wall");
              targetCol.setAttribute("data-col-type", "ground1");
              targetCol.style.backgroundImage = "url('" + this.groundsprite1 + "')";
            }
          }
        },
        pushblock: function() {
          var player = this.querySelector(".player");
          if (!player) {
            return;
          }
          var playerRow = player.offsetTop / 32;
          var playerCol = player.offsetLeft / 32;
          var targetCol;
          var direction = this.direction;
          var otherBlock;
          if (direction === "up") {
            if (playerRow === 0) {
              return;
            }
            playerRow--;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
            if (targetCol) {
              playerRow--;
              targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
              otherBlock = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
              if (otherBlock && !otherBlock.classList.contains("wall")) {
                targetCol.classList.remove("wall");
                otherBlock.classList.add("wall");
                otherBlock.setAttribute("data-col-type", targetCol.getAttribute("data-col-type"));
                targetCol.setAttribute("data-col-type", "ground1");
                otherBlock.style.backgroundImage = targetCol.style.backgroundImage;
                targetCol.style.backgroundImage = "url('" + this.groundsprite1 + "')";
              }
            }
          } else if (direction === "down") {
            if (playerRow === 8) {
              return;
            }
            playerRow++;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
            if (targetCol) {
              playerRow++;
              targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
              otherBlock = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
              if (otherBlock && !otherBlock.classList.contains("wall")) {
                targetCol.classList.remove("wall");
                otherBlock.classList.add("wall");
                otherBlock.setAttribute("data-col-type", targetCol.getAttribute("data-col-type"));
                targetCol.setAttribute("data-col-type", "ground1");
                otherBlock.style.backgroundImage = targetCol.style.backgroundImage;
                targetCol.style.backgroundImage = "url('" + this.groundsprite1 + "')";
              }
            }
          } else if (direction === "left") {
            if (playerCol === 0) {
              return;
            }
            playerCol--;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
            if (targetCol) {
              playerCol--;
              targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
              otherBlock = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
              if (otherBlock && !otherBlock.classList.contains("wall")) {
                targetCol.classList.remove("wall");
                otherBlock.classList.add("wall");
                otherBlock.setAttribute("data-col-type", targetCol.getAttribute("data-col-type"));
                targetCol.setAttribute("data-col-type", "ground1");
                otherBlock.style.backgroundImage = targetCol.style.backgroundImage;
                targetCol.style.backgroundImage = "url('" + this.groundsprite1 + "')";
              }
            }
          } else if (direction === "right") {
            if (playerCol === 8) {
              return;
            }
            playerCol++;
            var targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
            targetCol = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
            if (targetCol) {
              playerCol++;
              targetRow = this.querySelector('*[data-row="'+ playerRow + '"]');
              otherBlock = targetRow.querySelector('*[data-col="'+ playerCol + '"]');
              if (otherBlock && !otherBlock.classList.contains("wall")) {
                targetCol.classList.remove("wall");
                otherBlock.classList.add("wall");
                otherBlock.setAttribute("data-col-type", targetCol.getAttribute("data-col-type"));
                targetCol.setAttribute("data-col-type", "ground1");
                otherBlock.style.backgroundImage = targetCol.style.backgroundImage;
                targetCol.style.backgroundImage = "url('" + this.groundsprite1 + "')";
              }
            }
          }
        },
        enter: function(row, col) {
          var that = this;
          setTimeout( function() {
            var player = that.querySelector(".player");
            if (!player) {
              player = document.createElement("div");
              player.style.height = "32px";
              player.style.width = "32px";
              player.style.position = "absolute";

              player.classList.add("player");
              that.querySelector(".board").appendChild(player);
            }
            player.style.backgroundImage = "url('" + that.playersprite + "')";
            player.style.top = (row * 32) + "px";
            player.style.left = (col * 32) + "px";
            that.navigateHere();
          });
        },
        switched: function(color) {
          if (color !== "red" && color !== "blue" && color !== "green") {
            return;
          }
          var wallsToUnPress = this.querySelectorAll(".col.wall");
          for (var i = 0; i < wallsToUnPress.length; i++) {
            wallsToUnPress[i].classList.remove("pressed");
          }
          var wallsToPress = this.querySelectorAll("." + color + ".col.wall");
          for (var i = 0; i < wallsToPress.length; i++) {
            wallsToPress[i].classList.add("pressed");
          }
        },
        generateBoard: function() {
          var that = this;
          function paintBlock(block) {

            if (that.palette.indexOf("wall") === 0) {
              block.classList.add("wall");
            }

            block.setAttribute("data-col-type", that.palette);
            var selectedPalette = that.shadowRoot.querySelector(".palette-selected");
            var backgroundImage = selectedPalette.style.backgroundImage;
            block.style.backgroundImage = backgroundImage;
          }
          function paintObject(block) {

            var objectBlock = block.querySelector(".object-block");
            if (!objectBlock) {
              objectBlock = document.createElement("span");
              objectBlock.classList.add("object-block");
              objectBlock.style.position = "absolute";
              objectBlock.style.height = "100%";
              objectBlock.style.width = "100%";
              block.appendChild(objectBlock);
            }

            //block.setAttribute("data-col-type", that.palette);
            var selectedPalette = that.shadowRoot.querySelector(".palette-selected");
            var backgroundImage = selectedPalette.style.backgroundImage;
            objectBlock.style.backgroundImage = backgroundImage;
          }
          var isMouseDown = false;
          function onMouseUp() {
            isMouseDown = false;
            window.removeEventListener("mouseup", onMouseUp);
          }
          function onBlockMousedown(e) {
            if ((!that.palette && !that.objectPalette) || !that.classList.contains("selected")) {
              return;
            }
            e.preventDefault();
            window.addEventListener("mouseup", onMouseUp);
            isMouseDown = true;
            if (that.palette) {
              paintBlock(this);
            } else if (that.objectPalette) {
              paintObject(this);
            }
          }
          function onBlockOver() {
            if (!isMouseDown || (!that.palette && !that.objectPalette) || !that.classList.contains("selected")) {
              return;
            }
            if (that.palette) {
              paintBlock(this);
            } else if (that.objectPalette) {
              paintObject(this);
            }
          }
          var board = this.querySelector(".board");
          if (board) {
            var player = board.querySelector(".player");
            if (player) {
              player.parentNode.removeChild(player);
            }
            for (var r = 0; r < this.rows; r++) {
              var row = board.querySelector('*[data-row="'+ r + '"]');
              for (var c = 0; c < this.cols; c++) {
                var col = row.querySelector('*[data-col="'+ c + '"]');
                col.addEventListener("mousedown", onBlockMousedown);
                col.addEventListener("mouseover", onBlockOver);
                col.classList.remove("pressed");
              }
            }
          } else {
            board = document.createElement("div");
            board.classList.add("board");
            board.style.fontSize = 0;
            board.style.margin = "auto";
            board.style.width = "288px";
            board.style.position = "relative";

            for (var r = 0; r < this.rows; r++) {
              var row = document.createElement("div");
              row.style.margin = "auto";
              row.classList.add("row");
              row.setAttribute("data-row", r);
              if (r === 0) {
                row.classList.add("topside");
              } else if (r === 8) {
                row.classList.add("bottomside");
              }
              for (var c = 0; c < this.cols; c++) {
                var col = document.createElement("span");
                col.style.height = "32px";
                col.style.width = "32px";
                col.style.display = "inline-block";
                col.style.position = "relative";
                col.style.padding = 0;
                col.style.cursor = "pointer";
                col.classList.add("col");
                if (c === 0) {
                  col.classList.add("leftside");
                } else if (c === 8) {
                  col.classList.add("rightside");
                }

                col.setAttribute("data-col", c);
                col.addEventListener("mousedown", onBlockMousedown);
                col.addEventListener("mouseover", onBlockOver);
                col.setAttribute("data-col-type", "ground1");
                col.style.backgroundImage = "url('" + this.groundsprite1 + "')";
                row.appendChild(col);
              }
              board.appendChild(row);
            }
            this.appendChild(board);
          }
        }
      });
    </script>
</polymer-element>
